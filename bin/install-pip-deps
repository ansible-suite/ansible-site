#!/bin/bash

### Installs PIP dependencies of Ansible collections and roles
# Scans the collections and roles path for 'requirements.txt' files
# and installs PIP dependencies from these files


## Activate the project environment
source "$(dirname "$(readlink -f "$0")")/activate"


## Determine collections and roles path
eval "$(get-ansible-config COLLECTIONS_PATHS DEFAULT_ROLES_PATH | sed 's/\\/\\\\/g; s/"/\"/g')"

## Scan the collections and roles path for 'requirements.txt' files and install PIP dependencies

# Run pip install with dynamic composite requirements file generated by a subshell,
# referencing 'requirements.txt' files from collections and roles
pip install -r <(

    # modify shell behaviour
    shopt -s nullglob
    IFS=:

    # iterate over collections search paths
    for COLLECTIONS_PATH in $COLLECTIONS_PATHS; do

        # iterate over possible locations of requirements.txt
        for REQ_FILE in "$COLLECTIONS_PATH"/ansible_collections/*/*/requirements.txt; do
            echo "-r '$REQ_FILE'"
        done

    done

    # iterate over roles search paths
    for ROLES_PATH in $DEFAULT_ROLES_PATH; do

        # iterate over possible locations of requirements.txt
        for REQ_FILE in "$ROLES_PATH"/*/requirements.txt; do
            echo "-r '$REQ_FILE'"
        done

    done
)
