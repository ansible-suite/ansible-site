#!/bin/bash

### Installs PIP dependencies of Ansible collections and roles
# Scans the collections and roles path for 'requirements.txt' files
# and installs PIP dependencies from these files


## Activate the project environment
source "$(dirname "$(readlink -f "$0")")/activate"


## Ensure jq is available
ensure-jq


## Determine collections and roles path

# config from ansible
source <(
    ansible-config dump -f json |
    jq -r '.[] | select(.name == "COLLECTIONS_PATHS" or .name == "DEFAULT_ROLES_PATH") | "\(.name)=\"\(.value | join(":"))\""'
)


## Scan the collections and roles path for 'requirements.txt' files and install PIP dependencies

# Run pip install with dynamic composite requirements file generated by a subshell,
# referencing 'requirements.txt' files from collections and roles
pip install -r <(

    # modify shell behaviour
    shopt -s nullglob
    IFS=:

    # iterate over collections search paths
    for collection_path in $COLLECTIONS_PATHS; do

        # iterate over possible locations of requirements.txt
        for req_file in "$(realpath "$collection_path")"/ansible_collections/*/*/requirements.txt; do
            echo "-r \"$req_file\""
        done

    done

    # iterate over roles search paths
    for roles_path in $DEFAULT_ROLES_PATH; do

        # iterate over possible locations of requirements.txt
        for req_file in "$(realpath "$roles_path")"/*/requirements.txt; do
            echo "-r \"$req_file\""
        done

    done
)
