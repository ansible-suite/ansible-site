#!/bin/bash

### Generates a vault password
# This script generates a random vault password.
# An existing vault password is never overwritten.


## Activate the project environment
source "$(dirname "$(readlink -f "$0")")/activate"


## Get ansible vault password file location
eval "$(get-ansible-config DEFAULT_VAULT_PASSWORD_FILE)"


## Exit under certain conditions

# Exit if no password file path is defined
if [[ -z "$DEFAULT_VAULT_PASSWORD_FILE" ]]; then
    echo "$0: Ansible Vault password file path not defined, not generating a password." >&2
    exit 0
fi

# Exit if file exists
if [[ -e "$DEFAULT_VAULT_PASSWORD_FILE" ]]; then
    echo "$0: Ansible Vault password file exists, not overwriting." >&2
    exit 0
fi


## Generate the password file

# Print an informational message
echo "$0: Generating a password for Ansible Vault..." >&2

# Create the file with secure permissions before generating password
touch "$DEFAULT_VAULT_PASSWORD_FILE"
chmod 600 "$DEFAULT_VAULT_PASSWORD_FILE"

# Generate the password
openssl rand -base64 32 > "$DEFAULT_VAULT_PASSWORD_FILE"
