#!/bin/bash

### Installs Ansible collections and roles using Ansible Galaxy
# Performs the following actions:
#   - installs and/or upgrades Ansible collections from 'requirements.yml'
#   - reinstalls Ansible roles from 'requirements.yml',
#     as installing and/or upgrading only changed roles is not possible
#   - if current environment's venv is active, calls 'install-pip-deps'
#     to install PIP dependencies required by collections and roles

## Activate the project environment
source "$(dirname "$(readlink -f "$0")")/activate"


## Define variables
REQUIREMENTS="$ANSIBLESITE/requirements.yml"


## Install collections and roles

# install collections
ansible-galaxy collection install -r "$REQUIREMENTS" --upgrade

# install roles
ansible-galaxy role install -r "$REQUIREMENTS" --force


## Install PIP dependencies of collections and roles

# check if current environment's venv is active
if [[ "$VIRTUAL_ENV" = "$(realpath "$ANSIBLESITE_VENV")" ]]; then

    # calls 'install-pip-deps' to install PIP dependencies
    # of collections and roles
    install-pip-deps

fi
